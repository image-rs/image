name: Rust CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '5 16 * * 6'

jobs:
  base:
    uses: ./.github/workflows/base.yml
    with:
      msrv: '1.74.0'
      features: '["", "default", "rayon", "avif", "bmp", "dds", "exr", "ff", "gif", "hdr", "ico", "jpeg", "png", "pnm", "qoi", "tga", "tiff", "webp"]'
      cargo-fuzz: true
      benchmark-feature: 'benchmarks'
      msrv-pinned-dependencies: '["num-bigint@0.4.2"]'

  test_avif_decoding:
    runs-on: ubuntu-latest
    steps:
    - name: install-dependencies
      run: sudo apt update && sudo apt install ninja-build meson nasm
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - name: build
      run: cargo build -v --no-default-features --features="avif,avif-native"
      env:
        SYSTEM_DEPS_DAV1D_BUILD_INTERNAL: always

  build_fuzz_afl:
    name: "Fuzz targets (afl)"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@nightly
    - name: install-deps
      run: sudo apt-get -y install clang llvm
    - name: Cache Cargo Registry
      uses: Swatinem/rust-cache@v2
      with:
        cache-targets: false
        cache-all-crates: true
        cache-on-failure: true
    - name: Install cargo-afl
      run: cargo install --locked -f cargo-afl
    - name: build
      run: |
        cd fuzz-afl
        cargo check --bin reproduce_webp
        cargo check --bin reproduce_pnm
        cargo afl check --bin fuzz_webp
        cargo afl check --bin fuzz_pnm
      env:
        RUSTFLAGS: ""

  public_private_dependencies:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@nightly
    - name: build
      run: |
        echo '#![deny(exported_private_dependencies)]' | cat - src/lib.rs > src/lib.rs.0
        mv src/lib.rs.0 src/lib.rs
        echo 'cargo-features = ["public-dependency"]' | cat - Cargo.toml > Cargo.toml.0
        mv Cargo.toml.0 Cargo.toml
        # mark rayon crate as public
        sed -i 's/rayon = { ver/rayon = { public = true, ver/' Cargo.toml
        # mark num-traits crate as public
        sed -i 's/num-traits = { ver/num-traits = { public = true, ver/' Cargo.toml
        # cargo +nightly check
        cargo check
